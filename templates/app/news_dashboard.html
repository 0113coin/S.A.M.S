{% extends 'base.html' %}
{% block title %}SAMS ë‰´ìŠ¤ ëŒ€ì‹œë³´ë“œ{% endblock %}
{% block head_extra %}
<style>
.news-feed {
    max-height: 600px;
    overflow-y: auto;
}

.news-item {
    border-left: 4px solid #3b82f6;
    padding: 1.5rem;
    margin-bottom: 1rem;
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s;
}

.news-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.news-item.positive { border-left-color: #10b981; }
.news-item.negative { border-left-color: #ef4444; }
.news-item.neutral { border-left-color: #6b7280; }

.media-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.media-conservative { background: #fef3c7; color: #92400e; }
.media-neutral { background: #e0e7ff; color: #3730a3; }
.media-progressive { background: #dbeafe; color: #1e40af; }

.bias-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.bias-conservative { background: #fef2f2; color: #dc2626; }
.bias-neutral { background: #f3f4f6; color: #374151; }
.bias-progressive { background: #f0fdf4; color: #16a34a; }

.filter-controls {
    background: white;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.filter-group:last-child {
    margin-bottom: 0;
}

.filter-label {
    font-weight: 600;
    color: #374151;
    min-width: 80px;
}

.filter-select {
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    padding: 0.5rem;
    background: white;
    font-size: 0.875rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6b7280;
    font-size: 0.875rem;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
}

.error {
    text-align: center;
    padding: 2rem;
    color: #dc2626;
    background: #fef2f2;
    border-radius: 0.5rem;
    margin: 1rem 0;
}
</style>
{% endblock %}

{% block body %}
<div class="grid grid-cols-12 min-h-screen">
  <aside class="col-span-2 bg-white border-r">
    <div class="p-4 font-bold">SAMS</div>
    <nav class="px-2 space-y-1">
      <a href="{% url 'home' %}" class="block px-3 py-2 hover:bg-slate-50 rounded-lg">í™ˆ</a>
      <a href="{% url 'portfolio' %}" class="block px-3 py-2 hover:bg-slate-50 rounded-lg">í¬íŠ¸í´ë¦¬ì˜¤</a>
      <a href="{% url 'trading' %}" class="block px-3 py-2 hover:bg-slate-50 rounded-lg">ê±°ë˜</a>
      <a href="{% url 'simulation' %}" class="block px-3 py-2 hover:bg-slate-50 rounded-lg">ì‹œë®¬ë ˆì´ì…˜</a>
      <a class="block px-3 py-2 bg-slate-100 rounded-lg">ë‰´ìŠ¤</a>
      <a href="{% url 'admin' %}" class="block px-3 py-2 hover:bg-slate-50 rounded-lg">ê´€ë¦¬ì</a>
    </nav>
  </aside>

  <main class="col-span-10 bg-slate-50 p-4 space-y-6">
    <!-- í—¤ë” -->
    <div class="bg-white rounded-2xl shadow-soft p-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">AI ë‰´ìŠ¤ í”¼ë“œ</h1>
          <p class="text-gray-600 mt-2">ì‹œë®¬ë ˆì´ì…˜ì—ì„œ ìƒì„±ëœ AI ë‰´ìŠ¤ ê¸°ì‚¬ë“¤ì„ í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-500">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
          <div class="text-lg font-semibold" id="lastUpdate">-</div>
        </div>
      </div>
    </div>

    <!-- í•„í„° ì»¨íŠ¸ë¡¤ -->
    <div class="filter-controls">
      <div class="filter-group">
        <span class="filter-label">ì‹œë®¬ë ˆì´ì…˜:</span>
        <select id="simulationSelect" class="filter-select">
          <option value="default-sim">ê¸°ë³¸ ì‹œë®¬ë ˆì´ì…˜</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">ì–¸ë¡ ì‚¬:</span>
        <select id="mediaSelect" class="filter-select">
          <option value="">ì „ì²´ ì–¸ë¡ ì‚¬</option>
          <option value="ì¡°ì„ ì¼ë³´">ì¡°ì„ ì¼ë³´</option>
          <option value="í•œê²¨ë ˆ">í•œê²¨ë ˆ</option>
          <option value="ë§¤ì¼ê²½ì œ">ë§¤ì¼ê²½ì œ</option>
          <option value="KBS">KBS</option>
          <option value="MBC">MBC</option>
          <option value="SBS">SBS</option>
          <option value="YTN">YTN</option>
          <option value="ì—°í•©ë‰´ìŠ¤">ì—°í•©ë‰´ìŠ¤</option>
          <option value="ë‰´ì‹œìŠ¤">ë‰´ì‹œìŠ¤</option>
          <option value="ì´ë°ì¼ë¦¬">ì´ë°ì¼ë¦¬</option>
          <option value="ì„œìš¸ê²½ì œ">ì„œìš¸ê²½ì œ</option>
          <option value="í•œêµ­ê²½ì œ">í•œêµ­ê²½ì œ</option>
          <option value="ì•„ì‹œì•„ê²½ì œ">ì•„ì‹œì•„ê²½ì œ</option>
          <option value="í—¤ëŸ´ë“œê²½ì œ">í—¤ëŸ´ë“œê²½ì œ</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">ê°œìˆ˜:</span>
        <select id="limitSelect" class="filter-select">
          <option value="10">10ê°œ</option>
          <option value="20" selected>20ê°œ</option>
          <option value="50">50ê°œ</option>
          <option value="100">100ê°œ</option>
        </select>
        <button id="refreshBtn" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          ìƒˆë¡œê³ ì¹¨
        </button>
      </div>
    </div>

    <!-- í†µê³„ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value text-blue-600" id="totalNews">0</div>
        <div class="stat-label">ì´ ë‰´ìŠ¤ ê¸°ì‚¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-value text-green-600" id="totalEvents">0</div>
        <div class="stat-label">ì´ ì´ë²¤íŠ¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-value text-purple-600" id="avgCredibility">0.0</div>
        <div class="stat-label">í‰ê·  ì‹ ë¢°ë„</div>
      </div>
      <div class="stat-card">
        <div class="stat-value text-orange-600" id="mediaCount">0</div>
        <div class="stat-label">í™œì„± ì–¸ë¡ ì‚¬</div>
      </div>
    </div>

    <!-- ë‰´ìŠ¤ í”¼ë“œ -->
    <div class="bg-white rounded-2xl shadow-soft overflow-hidden">
      <div class="p-4 border-b">
        <h3 class="text-lg font-semibold">ë‰´ìŠ¤ ê¸°ì‚¬ ëª©ë¡</h3>
        <p class="text-sm text-slate-600 mt-1">ìµœì‹  ë‰´ìŠ¤ ê¸°ì‚¬ë“¤ì´ ì‹œê°„ìˆœìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</p>
      </div>
      
      <div class="p-4">
        <div id="newsFeed" class="news-feed">
          <div class="loading">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
            ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSimulationId = 'default-sim';
let currentMediaFilter = '';
let currentLimit = 20;

// ë‰´ìŠ¤ í”¼ë“œ ì¡°íšŒ
async function fetchNewsFeed() {
    const feedElement = document.getElementById('newsFeed');
    
    try {
        feedElement.innerHTML = `
            <div class="loading">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        `;
        
        const url = `/api/simulation/news/?simulation_id=${currentSimulationId}&limit=${currentLimit}${currentMediaFilter ? `&media=${currentMediaFilter}` : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            updateNewsFeed(data.data.news_feed);
            updateStats(data.data.news_feed);
            updateLastUpdate();
        } else {
            showError('ë‰´ìŠ¤ í”¼ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
        }
    } catch (error) {
        console.error('ë‰´ìŠ¤ í”¼ë“œ ì¡°íšŒ ì‹¤íŒ¨:', error);
        showError('ë‰´ìŠ¤ í”¼ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë‰´ìŠ¤ í”¼ë“œ ì—…ë°ì´íŠ¸
function updateNewsFeed(newsFeed) {
    const feedElement = document.getElementById('newsFeed');
    
    if (newsFeed.length === 0) {
        feedElement.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="text-4xl mb-2">ğŸ“°</div>
                <div class="text-lg font-medium">ë‰´ìŠ¤ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="text-sm">ì‹œë®¬ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì—¬ ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ìƒì„±í•´ë³´ì„¸ìš”</div>
            </div>
        `;
        return;
    }
    
    feedElement.innerHTML = newsFeed.map(news => {
        const sentimentClass = getSentimentClass(news.event_info.sentiment);
        const mediaClass = getMediaClass(news.outlet_bias);
        const biasClass = getBiasClass(news.outlet_bias);
        const biasText = getBiasText(news.outlet_bias);
        
        return `
            <div class="news-item ${sentimentClass}">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-2">
                        <span class="media-badge ${mediaClass}">${news.media_name}</span>
                        <span class="bias-indicator ${biasClass}">${biasText}</span>
                        <span class="text-sm text-gray-500">ì‹ ë¢°ë„: ${(news.outlet_credibility * 100).toFixed(0)}%</span>
                    </div>
                    <div class="text-xs text-gray-500">${formatTime(news.created_at)}</div>
                </div>
                
                <div class="mb-3">
                    <h4 class="font-semibold text-lg mb-2">${news.event_info.event_type}</h4>
                    <div class="text-sm text-gray-600 mb-2">
                        ì¹´í…Œê³ ë¦¬: ${news.event_info.category} | 
                        ê°ì„±: ${news.event_info.sentiment > 0 ? 'ê¸ì •' : news.event_info.sentiment < 0 ? 'ë¶€ì •' : 'ì¤‘ë¦½'} | 
                        ì˜í–¥ë„: ${news.event_info.impact_level}/5
                    </div>
                </div>
                
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-gray-800 leading-relaxed">${news.article_text}</p>
                </div>
            </div>
        `;
    }).join('');
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStats(newsFeed) {
    if (newsFeed.length === 0) {
        document.getElementById('totalNews').textContent = '0';
        document.getElementById('totalEvents').textContent = '0';
        document.getElementById('avgCredibility').textContent = '0.0';
        document.getElementById('mediaCount').textContent = '0';
        return;
    }
    
    // ì´ ë‰´ìŠ¤ ê¸°ì‚¬ ìˆ˜
    document.getElementById('totalNews').textContent = newsFeed.length;
    
    // ì´ ì´ë²¤íŠ¸ ìˆ˜ (ì¤‘ë³µ ì œê±°)
    const uniqueEvents = new Set(newsFeed.map(news => news.event_info.event_id));
    document.getElementById('totalEvents').textContent = uniqueEvents.size;
    
    // í‰ê·  ì‹ ë¢°ë„
    const avgCredibility = newsFeed.reduce((sum, news) => sum + news.outlet_credibility, 0) / newsFeed.length;
    document.getElementById('avgCredibility').textContent = avgCredibility.toFixed(1);
    
    // í™œì„± ì–¸ë¡ ì‚¬ ìˆ˜
    const uniqueMedia = new Set(newsFeed.map(news => news.media_name));
    document.getElementById('mediaCount').textContent = uniqueMedia.size;
}

// ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
function updateLastUpdate() {
    const now = new Date();
    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('ko-KR');
}

// ê°ì„± í´ë˜ìŠ¤ ë°˜í™˜
function getSentimentClass(sentiment) {
    if (sentiment > 0) return 'positive';
    if (sentiment < 0) return 'negative';
    return 'neutral';
}

// ì–¸ë¡ ì‚¬ í´ë˜ìŠ¤ ë°˜í™˜
function getMediaClass(bias) {
    if (bias < -0.3) return 'media-conservative';
    if (bias > 0.3) return 'media-progressive';
    return 'media-neutral';
}

// ì„±í–¥ í´ë˜ìŠ¤ ë°˜í™˜
function getBiasClass(bias) {
    if (bias < -0.3) return 'bias-conservative';
    if (bias > 0.3) return 'bias-progressive';
    return 'bias-neutral';
}

// ì„±í–¥ í…ìŠ¤íŠ¸ ë°˜í™˜
function getBiasText(bias) {
    if (bias < -0.3) return 'ë³´ìˆ˜';
    if (bias > 0.3) return 'ì§„ë³´';
    return 'ì¤‘ë¦½';
}

// ì‹œê°„ í¬ë§·íŒ…
function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return date.toLocaleString('ko-KR', { 
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit', 
        minute: '2-digit'
    });
}

// ì—ëŸ¬ í‘œì‹œ
function showError(message) {
    const feedElement = document.getElementById('newsFeed');
    feedElement.innerHTML = `
        <div class="error">
            <div class="text-lg font-medium mb-2">ì˜¤ë¥˜ ë°œìƒ</div>
            <div>${message}</div>
        </div>
    `;
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.getElementById('simulationSelect').addEventListener('change', (e) => {
    currentSimulationId = e.target.value;
    fetchNewsFeed();
});

document.getElementById('mediaSelect').addEventListener('change', (e) => {
    currentMediaFilter = e.target.value;
    fetchNewsFeed();
});

document.getElementById('limitSelect').addEventListener('change', (e) => {
    currentLimit = parseInt(e.target.value);
    fetchNewsFeed();
});

document.getElementById('refreshBtn').addEventListener('click', fetchNewsFeed);

// ì´ˆê¸° ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    fetchNewsFeed();
    
    // ìë™ ìƒˆë¡œê³ ì¹¨ (5ë¶„ë§ˆë‹¤)
    setInterval(fetchNewsFeed, 300000);
});
</script>
{% endblock %}
